eyui.define(["layer","form","element","util","jquery","service","dropdown","upload"],function(e){var i=eyui.layer,t=eyui.form,r=eyui.element,c=eyui.util,o=eyui.service,s=eyui.laytpl,a=(eyui.upload,eyui.dropdown,eyui.jquery);if(a.isEmptyObject(EY_Service.comm.faceData)){for(var n=EY_Service.lg.face_alt.split(","),f={},l=0;l<n.length;l++)f[n[l]]=EY_Service.plugurl+"/images/emotions/"+l+".gif";EY_Service.comm.faceData=f}retEySerEnter=function(e){var i=e.data;i.ol=1;var t=o.getRid(i.uid);a.isEmptyObject(EY_Service.userBase)?(EY_Service.userBase={},EY_Service.userBase[t]=i):a.isEmptyObject(EY_Service.userBase[t])||(EY_Service.userBase[t]=i),setEyUserStatus(i.uid,1)},retEyUserEnter=function(e){e.data.uid==EY_Service.uinfo.uid&&(T(),EY_Service.roomPage&&EY_Service.roomPage[EY_Service.roomIndex]&&o.setSpeakStatus(EY_Service.roomIndex),setTimeout(function(){d()},1e3))},retEyPing=function(e){a("#serviceTab").find(".eyui-tab-title:first").find("li[class='eyui-this']").each(function(){var e=a(this).attr("lay-id");updateChatTipTime(e,o.curtime())})},retEySiteLeave=function(e){var i=o.getRid(e.uid);a.isEmptyObject(EY_Service.userBase)||a.isEmptyObject(EY_Service.userBase[i])||(delete EY_Service.userBase[i].ol,delete EY_Service.userBase[i].oid),o.setWin2Me(0,e.uid),setEyUserStatus(e.uid,0)},retEyChatUser=function(e){var i=e.data;o.setLocalChat(i.uid==EY_Service.uinfo.uid?i.oid:i.uid,i);var t=eyui.sessionData("EyWin");return t.ser&&t.ser.open?void(i.uid==EY_Service.uinfo.uid?(o.setChatItem(i.rid,i),o.bottomScroll(i.rid)):o.hasWin2Me(i.uid)&&EY_Service.uinfo.uid==i.oid?(o.setChatItem(i.rid,i),o.bottomScroll(i.rid),o.playVoice()):(a.isEmptyObject(t)?(t.ser={},t.ser.tip_chat=i.uid,eyui.sessionData("EyWin",{key:"ser",value:t.ser})):(t.ser.tip_chat=i.uid,eyui.sessionData("EyWin",{key:"ser",value:t.ser})),t.ser.tip_chat>0&&a("#ey_service_menu").find("li[lay-type='service'][data='"+t.ser.tip_chat+"']").trigger("click"))):void a("#ey_service_menu").find("li[lay-type='service'][data='"+i.uid+"']").trigger("click")},setEyUserStatus=function(e,i){var t=o.getRid(e);EY_Service.userBase&&EY_Service.userBase[t]&&("1"==i?(EY_Service.userBase[t].ol=1,a("#serviceTab").find("li[lay-id='"+t+"']").find(".user-status").removeClass("eyui-bg-gray2").addClass("eyui-bg-blue")):(delete EY_Service.userBase[t].ol,a("#serviceTab").find("li[lay-id='"+t+"']").find(".user-status").removeClass("eyui-bg-blue").addClass("eyui-bg-gray2"),v(e)))};var v=function(e){EY_Service.sercfg.offline_reply&&!a.isEmptyObject(EY_Service.sercfg.offline_reply[e])&&setTimeout(function(){a("#serviceframe").find(".chat-list").append('<fieldset class="eyui-elem-field"><legend><i class="eyui-icon eyui-icon-notice"></i></legend><div class="eyui-field-box">'+EY_Service.sercfg.offline_reply[e]+"</div></fieldset>")},500)},u=function(){var e={};return e.title=document.title,e.url=window.location.href,e.time=o.curtime(),e},d=function(){var e={};e.action="eys_setTrack",e.formhash=EY_Service.formhash,e.uinfo=EY_Service.uinfo,e.pinfo=u(),a.ajax({type:"POST",url:EY_Service.ajxurl,data:e,dataType:"json",success:function(e){}})},y=function(){_({bgcolor:EY_Service.cfg.backcolor,click:function(e){if("qq"===e)window.location.href="tencent://message/?Menu=yes&amp;uin="+a(this).attr("data");else if("wechat"===e);else if("phone"===e);else if("mail"===e){var t='<form class="eyui-form eyui-form-pane">';t+='<div class="eyui-form-item eyui-form-text">',t+='\t<label class="eyui-form-label">'+EY_Service.lg.content+"</label>",t+='\t<div class="eyui-input-block"><textarea placeholder="'+EY_Service.lg.input+EY_Service.lg.content+'" name="content" required  lay-verify="required" class="eyui-textarea"></textarea></div>',t+="</div>",t+='<div class="eyui-form-item"><input type="hidden" name="mail" value="'+a(this).attr("data")+'"/>',t+='<label class="eyui-form-label">'+EY_Service.lg.user_mail+"</label>",t+='<div class="eyui-input-block">',t+='\t<input type="text" name="usermail" required lay-verify="email" placeholder="'+EY_Service.lg.input+EY_Service.lg.user_mail+'" autocomplete="off" class="eyui-input" value="">',t+="</div>",t+="</div>",t+='<div class="eyui-form-item">',t+='\t<div class="eyui-input-block">',t+='\t<button class="eyui-btn" lay-submit lay-filter="formemail">'+EY_Service.lg.submit+"</button>",t+='\t<button type="reset" class="eyui-btn eyui-btn-primary">'+EY_Service.lg.reset+"</button>",t+="\t</div>",t+="</div>",t+="</form>",i.open({type:1,area:[EY_Service.cfg.onlinewidth+"px"],offset:EY_Service.cfg.onlineoffset,id:"ey_mail",content:'<div style="padding:15px;">'+t+"</div>",shade:0,success:function(e,i){a("#ey_service_menu").hide()},cancel:function(e,i){a("#ey_service_menu").show()}})}}})},_=function(e){var t="ey-eyui-fixbar",r="ey-eyui-fixbar-top",c=a("body");e=a.extend({showHeight:200},e);var s="";if(EY_Service.uinfo.lvl==o.ser)s+='<li class="eyui-icon" lay-type="servicecenter" data="'+EY_Service.uinfo.uid+'">&#xe626;</li>';else{var n={};n=EY_Service.sers;for(var f in n)s+='<li class="eyui-icon" lay-type="service" data="'+f+'">&#xe626;</li>'}if(EY_Service.cfg.severqq){var l={};l=JSON.parse(EY_Service.cfg.severqq);for(var f in l)s+='<li class="eyui-icon" lay-type="qq" data="'+l[f]+'">&#xe676;</li>'}if(EY_Service.cfg.severwechat){var v={};v=JSON.parse(EY_Service.cfg.severwechat);for(var f in v)s+='<li class="eyui-icon" lay-type="wechat" data="'+v[f]+'">&#xe677;</li>'}if(EY_Service.cfg.severphone){var u={};u=JSON.parse(EY_Service.cfg.severphone);for(var f in u)s+='<li class="eyui-icon" lay-type="phone" data="'+u[f]+'">&#xe678;</li>'}if(EY_Service.cfg.severmail){var d={};d=JSON.parse(EY_Service.cfg.severmail);for(var f in d)s+='<li class="eyui-icon" lay-type="mail" data="'+d[f]+'">&#xe618;</li>'}var y=a(['<ul class="'+t+'" id="ey_service_menu">',s,'<li class="eyui-icon '+r+'" lay-type="top" style="'+e.bgcolor+'">&#xe604;</li>',"</ul>"].join("")),_=(y.find("."+r),function(e){});a("."+t)[0]||("object"==typeof e.css&&y.css(e.css),c.append(y),_(),a("#ey_service_menu").find("li").css({width:EY_Service.cfg.width,height:EY_Service.cfg.width,"line-height":EY_Service.cfg.width+"px",border:"solid 1px #eee"}),a("#ey_service_menu").find(".eyui-icon").css({"background-color":EY_Service.cfg.backcolor,"font-size":EY_Service.cfg.width>30?EY_Service.cfg.width-20:EY_Service.cfg.width-10,color:EY_Service.cfg.iconcolor}),y.find("li").on("click",function(){var i=a(this),t=i.attr("lay-type"),r=i.attr("data");if("top"===t)a("html,body").animate({scrollTop:0},200);else if("service"===t){var c={};c.uid=r,c.name=EY_Service.sers[r],m(c)}else"serviceopen"===t?a(".eyui-layim").show():"servicecenter"===t&&E(r);e.click&&e.click.call(this,t)}),y.find("li").on("mouseover",function(){var t=a(this),r=t.attr("lay-type"),c="";if("serviceopen"!=r){if("qq"==r)c="QQ:"+t.attr("data");else if("wechat"==r)c='<div style="width:180px;"><img src="'+t.attr("data")+'" style="max-width:180px;"/></div>';else if("phone"==r)c=EY_Service.lg.phone+":"+t.attr("data");else if("mail"==r)c=EY_Service.lg.mail+":"+t.attr("data");else if("service"==r){var o=t.attr("data");c=EY_Service.lg.plugin_name+":"+EY_Service.sers[o]}else if("servicecenter"==r)return;"t"==EY_Service.cfg.position?i.tips(c,a(this),{tips:[3,EY_Service.cfg.backcolor]}):"b"==EY_Service.cfg.position?i.tips(c,a(this),{tips:[1,EY_Service.cfg.backcolor]}):"r"==EY_Service.cfg.position||"rt"==EY_Service.cfg.position||"rb"==EY_Service.cfg.position?i.tips(c,a(this),{tips:[4,EY_Service.cfg.backcolor]}):"l"!=EY_Service.cfg.position&&"lt"!=EY_Service.cfg.position&&"lb"!=EY_Service.cfg.position||i.tips(c,a(this),{tips:[2,EY_Service.cfg.backcolor]}),e.hover&&e.hover.call(this,r)}}))};t.on("submit(formemail)",function(e){var t={};return t=e.field,t.formhash=EY_Service.formhash,t.uinfo=EY_Service.uinfo,a.ajax({type:"POST",url:EY_Service.ajxurl+"&act=sendtomail",data:t,dataType:"json",success:function(e){"1"==e.code?(i.close(i.index),i.msg(EY_Service.lg.act_success)):i.msg(EY_Service.lg.act_fail)}}),a("#ey_service_menu").show(),!1});var E=function(e){location.href=EY_Service.comm.centerurl},p=function(){var e=this,i=a(window),t=a("#ey_service_menu"),r=[t.outerWidth(),t.outerHeight()];e.offsetTop=(i.height()-r[1])/2,e.offsetLeft=(i.width()-r[0])/2,"t"===EY_Service.cfg.position?(e.offsetTop=0,e.offsetLeft=e.offsetLeft-t.find("li").length*(EY_Service.cfg.width/2)):"r"===EY_Service.cfg.position?e.offsetLeft=i.width()-r[0]:"b"===EY_Service.cfg.position?e.offsetLeft=e.offsetLeft-t.find("li").length*(EY_Service.cfg.width/2):"l"===EY_Service.cfg.position?e.offsetLeft=0:"lt"===EY_Service.cfg.position?(e.offsetTop=0,e.offsetLeft=0):"lb"===EY_Service.cfg.position?(e.offsetTop=i.height()-r[1],e.offsetLeft=0):"rt"===EY_Service.cfg.position?(e.offsetTop=0,e.offsetLeft=i.width()-r[0]):"rb"===EY_Service.cfg.position?(e.offsetTop=i.height()-r[1],e.offsetLeft=i.width()-r[0]):e.offsetTop=EY_Service.cfg.position,"t"==EY_Service.cfg.position?(t.css({height:EY_Service.cfg.width+"px",width:t.find("li").length*EY_Service.cfg.width+"px",top:e.offsetTop,left:e.offsetLeft}),t.find("li").css({"float":"left","margin-right":"1px"})):"b"==EY_Service.cfg.position?(t.css({height:EY_Service.cfg.width+"px",width:t.find("li").length*EY_Service.cfg.width+"px",bottom:0,left:e.offsetLeft}),t.find("li").css({"float":"left","margin-right":"1px"})):t.css({height:t.find("li").length*EY_Service.cfg.width+"px",width:EY_Service.cfg.width+"px",top:e.offsetTop})},S=function(e){a.isEmptyObject(EY_Service.roomPage[e])&&(EY_Service.roomPage[e]={}),r.tabChange("serviceTab",e),EY_Service.roomPage[e].isScroll=!0,EY_Service.roomPage[e].objRoomCenter=a("#serviceTab").find(".eyui-show").find(".room-center"),EY_Service.roomPage[e].objChatArea=EY_Service.roomPage[e].objRoomCenter.find(".chat-cont"),EY_Service.roomPage[e].objChatAct=EY_Service.roomPage[e].objRoomCenter.find(".act-area"),EY_Service.roomPage[e].objInput=EY_Service.roomPage[e].objRoomCenter.find(".chat-input"),EY_Service.roomPage[e].objSend=EY_Service.roomPage[e].objRoomCenter.find(".chat-send"),EY_Service.roomPage[e].objRoomRight=a("#serviceTab").find(".eyui-show").find(".room-right");var i=EY_Service.roomPage[e];i.objChatArea.height(a("#ey_ser").height()-185),a("#ey_ser").next(".eyui-layer-setwin").find("a").css("top","-10px"),a("#serviceframe").css({height:a("#ey_ser").height()-5,width:a("#ey_ser").width()-5}),o.bindCheckContent(i),o.bindEyToolsFace(i.objRoomCenter.find("button[ey-active='EyToolsFace']")),o.bindEyToolsUpimage(e),o.bindEyToolsUpfile(e),o.setRenderChat(e,!0),o.bottomScroll(e)};updateChatTipTime=function(e,i){var t=EY_Service.roomPage[e];if(!a.isEmptyObject(t)){c.timeAgo(1e3*i);t.objChatArea.find(".chat-list").find(".time-tip").each(function(e){var i=c.timeAgo(1e3*a(this).attr("time"));a(this).attr("data",i),a(this).find("span").html(i)}),t.isTrack&&t.objRoomRight.find(".track-item").each(function(e){var i=c.timeAgo(1e3*a(this).attr("time"));a(this).find(".track-time").html(i)})}},c.event("ey-active",{EyToolsQr:function(){},EyToolsHistory:function(){o.setRenderHistory(EY_Service.roomIndex),o.setEyChatStatus(EY_Service.userBase[EY_Service.roomIndex].uid)},EyToolsClear:function(){a("#serviceTab").find(".eyui-show").find(".chat-list").html("")},EyToolsScroll:function(e){EY_Service.roomPage[EY_Service.roomIndex].isScroll?(EY_Service.roomPage[EY_Service.roomIndex].isScroll=!1,a(e).find(".eyui-icon").removeClass("eyui-icon-ok-circle").addClass("eyui-icon-circle")):(EY_Service.roomPage[EY_Service.roomIndex].isScroll=!0,a(e).find(".eyui-icon").removeClass("eyui-icon-circle").addClass("eyui-icon-ok-circle"),o.bottomScroll(EY_Service.roomIndex))},EyToolsSend:function(e){o.setContent(EY_Service.roomIndex)}});var m=function(e){if(e.lvl=o.ser,!EY_Service.uinfo.oid){EY_Service.roomIndex=o.setInitRoomData(e),o.setChatChange(e.uid);var i=eyui.sessionData("EyWin");a.isEmptyObject(i.ser)?(i.ser={},i.ser.open=1):1==i.ser.open&&(EY_Service.cfg.onlineoffset=[i.ser.top+"px",i.ser.left+"px"]),i.ser.obj=e,eyui.sessionData("EyWin",{key:"ser",value:i.ser}),Y(EY_Service.roomIndex)}},g=function(e){EY_Service.uinfo.oid&&(pdata={},pdata.oid=EY_Service.uinfo.oid,pdata.uid=EY_Service.uinfo.uid,pdata.act=0,o.sendSocket("sendChatChange",pdata),delete EY_Service.uinfo.oid),eyui.sessionData("EyWin",{key:"ser",value:{}})},h=function(e){if(0==a("#serviceTab").find("li[lay-id='"+e+"']").length){var i={};i.base=EY_Service.userBase[e],i.base.avatar=o.getUserAvatar(i.base.uid),i.conf=EY_Service.cfg,s(a("#chat-frame-tpl").html()).render(i,function(t){r.tabAdd("serviceTab",{title:'<i class="eyui-icon eyui-icon-service"></i> '+i.base.name+'<span class="eyui-badge-dot eyui-bg-gray2 user-status"></span>',content:t,id:e})}),S(e),o.setSpeakStatus(e)}else r.tabChange("serviceTab",e)},Y=function(e){i.open({type:1,title:[EY_Service.cfg.title,"font-size:12px;line-height:30px;height:30px"],area:[EY_Service.cfg.onlinewidth+"px",EY_Service.cfg.onlineheight+"px"],offset:EY_Service.cfg.onlineoffset,id:"ey_ser",content:a("#serviceframe-tpl").html(),shade:0,success:function(i,t){h(e);var r=eyui.sessionData("EyWin");r.ser.open=1,r.ser.tip_chat=0,r.ser.top=i[0].offsetTop,r.ser.left=i[0].offsetLeft,eyui.sessionData("EyWin",{key:"ser",value:r.ser}),a("#ey_service_menu").hide()},cancel:function(i,t){g(e),a("#ey_service_menu").show()},moveEnd:function(e){var i=eyui.sessionData("EyWin");i.ser.open=1,i.ser.top=e[0].offsetTop,i.ser.left=e[0].offsetLeft,eyui.sessionData("EyWin",{key:"ser",value:i.ser})}})},b=function(){var e={};e.action="eys_getOfflineMsg",e.formhash=EY_Service.formhash,e.uinfo=EY_Service.uinfo,a.ajax({type:"POST",url:EY_Service.ajxurl,data:e,dataType:"json",success:function(e){"1"==e.code&&e.data.length>0&&x(e.data)}})},x=function(e){var i=[];for(var t in e){o.delLocalChat(e[t].uid),a("#ey_service_menu").find("li[lay-type='service'][data='"+e[t].uid+"']").trigger("click"),i=eyui.delArray(e,t);break}i.length<1?w():eyui.data("EyOffMsg",{key:EY_Service.uinfo.uid,value:i})},w=function(){eyui.data("EyOffMsg",{key:EY_Service.uinfo.uid,remove:!0})},T=function(){var e=eyui.sessionData("EyWin");if(!e.ser)return w(),void b();var i=eyui.data("EyOffMsg")[EY_Service.uinfo.uid]||{},t=i||{};return a.isEmptyObject(t)?void(a.isEmptyObject(e)||("1"==e.ser.open&&e.ser.obj?(EY_Service.cfg.onlineoffset=[e.ser.top+"px",e.ser.left+"px"],a("#ey_service_menu").find("li[lay-type='service'][data='"+e.ser.obj.uid+"']").trigger("click")):e.ser.tip_chat&&a("#ey_service_menu").find("li[lay-type='service'][data='"+e.ser.tip_chat+"']").trigger("click"))):void x(t)};"WebSocket"in window?(y(),p(),setTimeout(function(){var e={};e=a.parseJSON(JSON.stringify(EY_Service.uinfo)),e.pinfo=u(),o.setWebSocket(EY_Service.cfg.socket,EY_Service.comm.v,e)},1e3)):alert(EY_Service.lg.verlow),e("servicepc",{})});