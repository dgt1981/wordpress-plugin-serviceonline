eyui.define(["layer","form","element","util","jquery","dropdown","service","upload","rate"],function(e){var i=eyui.layer,t=eyui.form,a=eyui.element,o=eyui.util,r=eyui.laytpl,n=eyui.dropdown,c=eyui.service,s=(eyui.upload,eyui.jquery);if(s.isEmptyObject(EY_Service.comm.faceData)){for(var u=EY_Service.lg.face_alt.split(","),l={},f=0;f<u.length;f++)l[u[f]]=EY_Service.plugurl+"/images/emotions/"+f+".gif";EY_Service.comm.faceData=l}updateChatTipTime=function(e,i){var t=EY_Service.roomPage[e];if(!s.isEmptyObject(t)){o.timeAgo(1e3*i);t.objChatArea.find(".chat-list").find(".time-tip").each(function(e){var i=o.timeAgo(1e3*s(this).attr("time"));s(this).attr("data",i),s(this).find("span").html(i)}),t.isTrack&&t.objRoomRight.find(".track-item").each(function(e){var i=o.timeAgo(1e3*s(this).attr("time"));s(this).find(".track-time").html(i)})}};var m=function(e){var i={};i=O(c.getOid(e)),s.isEmptyObject(i)&&(i=EY_Service.userBase[e]),n.render({elem:EY_Service.roomPage[e].objRoomRight.find("button[ey-active='EyToolsUseredit']"),content:r(s("#useredit-tpl").html()).render(i),className:"user-edit",ready:function(e){t.val("formuseredit",i)}})},v=function(e){};t.on("submit(demo1)",function(e){return i.alert(JSON.stringify(e.field),{title:"最终的提交信息"}),!1}),retEyTipMsg=function(e){var i=e.data.rid,t=EY_Service.roomPage[i];switch(e.v){case"tipjoin":t.objChatArea.find(".chat-list").find('.items-msg-tip[data="tipjoin_'+e.data.uid+'"]').length<1&&(t.objChatArea.find(".chat-list").append('<li class="items-msg-tip" data="tipjoin_'+e.data.uid+'"><span>'+EY_Service.lg.welcome1+e.data.name+EY_Service.lg.welcome2+"</span></li>"),c.bottomScroll(i)),setMemberAdd(i,e.data);break;case"tipbeyond":y(e.data);break;case"tipspeaker":E(e.data)}};var E=function(e){i.alert(e,{title:'<i class="eyui-icon eyui-icon-speaker"></i> 来自网站大喇叭的消息：'})},y=function(e){i.tips("迸发用户超限,超限用户将无法显示,请尽快到后台做扩容操作。",".contactnumb:first",{tips:[1,"#bd6023"],time:0,closeBtn:1})};retEyPing=function(e){s("#serviceTab").find(".eyui-tab-title:first").find("li[class='eyui-this']").each(function(){var e=s(this).attr("lay-id");updateChatTipTime(e,c.curtime())})},retEySiteLeave=function(e){var i=c.getRid(e.uid);!s.isEmptyObject(EY_Service.userBase)&&EY_Service.userBase[i]&&(delete EY_Service.userBase[i].ol,delete EY_Service.userBase[i].oid),setEyUserOffline(e.uid)},retEySerEnter=function(e){if(e.data.uid==EY_Service.uinfo.uid){if(!EY_Service.roomIndex){S(),c.getUserOnline();var i=O();if(!s.isEmptyObject(i)){var t="";for(var a in i)i[a].uid!=EY_Service.uinfo.uid&&(i[a].avatar=c.getUserAvatar(i[a].uid),t+=g(i[a]));s(".contactlist").eq(1).html(t),s(".contactnumb").eq(1).html(s(".contactlist").eq(1).find(".user-item").length)}return}c.setSpeakStatus(EY_Service.roomIndex)}},retEyUserOnline=function(e){var i=e.data,t=[],a=O(),o="";for(var r in i)i[r].uid!=EY_Service.uinfo.uid&&i[r].lvl!=c.ser&&(s.isEmptyObject(a[i[r].uid])||(i[r]=a[i[r].uid]),i[r].avatar=c.getUserAvatar(i[r].uid),i[r].ol=1,i[r].ext=a[i[r].uid]&&a[i[r].uid].ext?a[i[r].uid].ext:"",o+=g(i[r]),setEyUserOnline(i[r].uid),t.push(i[r].uid));s(".contactlist:first").html(o);var n={};n.uinfo=EY_Service.uinfo,n.exisid=t,n.formhash=EY_Service.formhash,n.uinfo=EY_Service.uinfo,n.action="eys_getOfflineMsg",s.ajax({type:"POST",url:EY_Service.ajxurl,data:n,dataType:"json",success:function(e){if("1"==e.code){if(!s.isEmptyObject(e.member))for(var i in e.member)x(i,e.member[i]),P(c.getRid(i),e.member[i]);if(e.data.length>0){a=O();var t,o="",r={};for(var i in e.data)r=a[e.data[i].uid],o=c.replaceContent(e.data[i].content),t=s(".contactlist:first").find(".user-item[data='"+e.data[i].uid+"']"),t.length>0&&t.find(".user-ext").html(o),r&&!s.isEmptyObject(r)||(r={},r.uid=e.data[i].uid,r.name=EY_Service.lg.visitor+e.data[i].uid,r.lvl=e.data[i].lvl>0?EY_Service.lg.service:0==e.data[i].lvl?EY_Service.lg.member:EY_Service.lg.visitor),r.avatar=c.getUserAvatar(r.uid),r.ext=o,x(r.uid,r),s(".contactlist:first").append(g(r)),_(e.data[i].uid,e.data[i].total),c.delLocalChat(e.data[i].uid)}}}}),s(".contactnumb:first").html(s(".contactlist:first").find(".user-item").length)},retEyUserEnter=function(e){var i=e.data,t=c.setInitRoomData(i);EY_Service.userBase[t].ol=1,s(".contactlist:first").find(".user-item[data='"+i.uid+"']").length<1&&(c.playVoice("door"),i.avatar=c.getUserAvatar(i.uid),i.ol=EY_Service.userBase[t].ol,s(".contactlist:first").append(g(i)),s(".contactnumb:first").html(s(".contactlist:first").find(".user-item").length)),setEyUserOnline(i.uid);var a=O();s.isEmptyObject(a[i.uid])||p(i.uid,a[i.uid].ext),EY_Service.roomPage[t]&&EY_Service.roomPage[t].isTrack&&(R(i.uid,i.pinfo),k(t,i.pinfo))};var S=function(){s("#serviceTab").find(".eyui-tab-content").html(r(s("#welcome-tpl").html()).render(d={})),s(".contactlist").css({"max-height":s("#tip-welcome").height()}),s(".contactlist").find(".user-item").removeClass("user-item-bgcolor")},h=function(){s("#tip-welcome").remove()},g=function(e){return s(".contactlist").eq(0).find(".user-item[data='"+e.uid+"']").length>0?"":r(s("#useritem-tpl").html()).render(e)};setEyUserStatus=function(e,i){"1"==i?setEyUserOnline(e):"0"==i&&setEyUserOffline(e)},setEyUserOnline=function(e){var i=s(".contactlist:first").find(".user-item[data='"+e+"']"),t=s(".contactlist").eq(1).find(".user-item[data='"+e+"']");i.find(".user-status").removeClass("eyui-bg-gray2"),i.find(".user-status").addClass("eyui-bg-blue"),t.find(".user-status").removeClass("eyui-bg-gray2"),t.find(".user-status").addClass("eyui-bg-blue")},setEyUserOffline=function(e){var i=s(".contactlist:first").find(".user-item[data='"+e+"']"),t=s(".contactlist").eq(1).find(".user-item[data='"+e+"']");i.find(".user-status").removeClass("eyui-bg-blue"),i.find(".user-status").addClass("eyui-bg-gray2"),t.find(".user-status").removeClass("eyui-bg-blue"),t.find(".user-status").addClass("eyui-bg-gray2")};var _=function(e,i){var t=arguments[2]?arguments[2]:0,a=s("#serviceframe").find(".contactlist").eq(t).find(".user-item[data='"+e+"']").find(".user-ext");return 0==i?void a.find("span").remove():void(a.find("span").length>0?a.find("span").html(parseInt(a.find("span").html())+i):a.prepend('<span class="eyui-badge-rim eyui-font-red">'+i+"</span> "))},p=function(e,i){var t=arguments[2]?arguments[2]:0,a=s("#serviceframe").find(".contactlist").eq(t).find(".user-item[data='"+e+"']").find(".user-ext");a.find("span").length>0?a.html(a.find("span").prop("outerHTML")+" "+i):a.html(i)};retEyChatUser=function(e){var i=e.data,t=O(),a=i.uid==EY_Service.uinfo.uid?i.oid:i.uid;c.setLocalChat(a,i);var o={};if(s.isEmptyObject(t[a])){var r=s("#serviceframe").find(".contactlist:first").find(".user-item[data='"+a+"']");o=JSON.parse(decodeURIComponent(r.find(".user-title").data("json")))}else o=t[a];delete o.ol,o.ext=i.content,x(o.uid,o),s.isEmptyObject(EY_Service.roomPage)||s.isEmptyObject(EY_Service.roomPage[i.rid])?i.content=c.replaceContent(i.content):(c.setChatItem(i.rid,i),c.bottomScroll(i.rid),i.uid!=EY_Service.uinfo.uid&&c.playVoice()),i.rid!=EY_Service.roomIndex&&(0==s("#serviceTab").find(".eyui-tab-title:first").find("li[lay-id='"+i.rid+"']").find(".eyui-badge-dot").length&&s("#serviceTab").find(".eyui-tab-title:first").find("li[lay-id='"+i.rid+"']").find(".eyui-icon-close").before('<span class="eyui-badge-dot"></span>'),_(a,1)),p(a,i.content,0),p(a,i.content,1)};var b=function(e){var i=EY_Service.roomPage[e],t=i.objRoomCenter.find(".chat-cont").height(),a=i.objRoomRight.find(".user-info").height();i.objRoomRight.find(".eyui-timeline").css("max-height",t-a);var o=c.getOid(e);if(i.isTrack){var r=eyui.data("EyTrack")[EY_Service.uinfo.uid]||{},n=r||{};if(s.isEmptyObject(n[o])){var d={};d.uinfo=EY_Service.uinfo,d.formhash=EY_Service.formhash,d.action="eys_getTrack",d.rid=e,s.ajax({type:"POST",url:EY_Service.ajxurl,data:d,dataType:"json",success:function(i){if("1"==i.code&&i.data){i.data=eyui.sort(i.data,"time");for(var t in i.data)R(i.msg,i.data[t]),k(e,i.data[t])}}})}else for(var u in n[o])k(e,n[o][u])}var l=O(o),f=eyui.rate;f.render({elem:i.objRoomRight.find(".user-rate"),value:l.rate?l.rate:0,choose:function(e){setEyUserField("rate",e)}});var d={};return d.oinfo=s.isEmptyObject(l)?s.parseJSON(JSON.stringify(EY_Service.userBase[e])):l,d.oinfo.lvl<0&&d.oinfo.address?void i.objRoomRight.find(".user-address").html(d.oinfo.address):void(d.oinfo.ip&&(d.uinfo=EY_Service.uinfo,d.formhash=EY_Service.formhash,d.action="eys_getAddressByIp",d.rid=e,s.ajax({type:"POST",url:EY_Service.ajxurl,data:d,dataType:"json",success:function(t){"1"==t.code&&(""!=t.address&&(d.oinfo.address=t.address,EY_Service.userBase[e].address=t.address,i.objRoomRight.find(".user-address").html(t.address)),""!=t.location&&(d.oinfo.location=t.location,EY_Service.userBase[e].location=t.location),x(d.oinfo.uid,d.oinfo))}})))},Y=function(e){var i=EY_Service.roomPage[e];s(".contactlist").css({"max-height":i.objRoomCenter.height()})},j=function(e){s.isEmptyObject(EY_Service.roomPage[e])&&(EY_Service.roomPage[e]={}),a.tabChange("serviceTab",e),EY_Service.roomPage[e].isScroll=!0,EY_Service.roomPage[e].isTrack=!0,EY_Service.roomPage[e].objRoomCenter=s("#serviceTab").find(".eyui-show").find(".room-center"),EY_Service.roomPage[e].objChatArea=EY_Service.roomPage[e].objRoomCenter.find(".chat-cont"),EY_Service.roomPage[e].objChatAct=EY_Service.roomPage[e].objRoomCenter.find(".act-area"),EY_Service.roomPage[e].objInput=EY_Service.roomPage[e].objRoomCenter.find(".chat-input"),EY_Service.roomPage[e].objSend=EY_Service.roomPage[e].objRoomCenter.find(".chat-send"),EY_Service.roomPage[e].objRoomRight=s("#serviceTab").find(".eyui-show").find(".room-right");var i=EY_Service.roomPage[e];i.objChatArea.height(s(window).height()-220),c.bindCheckContent(i),c.bindEyToolsFace(i.objRoomCenter.find("button[ey-active='EyToolsFace']")),c.bindEyToolsUpimage(e),c.bindEyToolsUpfile(e),m(e),v(e),c.setRenderChat(e,!0),c.bottomScroll(e),b(e),Y(e),s("#header").hide()},C=function(e){h();var t={};t.base=EY_Service.userBase[e],t.base.avatar=c.getUserAvatar(t.base.uid),t.conf=EY_Service.cfg,r(s("#room-frame-tpl").html()).render(t,function(i){a.tabAdd("serviceTab",{title:'<span class="user-name" uid="'+t.base.uid+'">'+t.base.name+"</span>",content:i,id:e})}),j(e),c.setSpeakStatus(e),i.closeAll("loading",function(){})},T=function(e){var t={};t.base=EY_Service.userBase[e],t.base.avatar=c.getUserAvatar(t.base.uid),t.conf=EY_Service.cfg,r(s("#room-frame-tpl").html()).render(t,function(a){i.open({type:1,title:['<span class="user-name" uid="'+t.base.uid+'">'+t.base.name+"</span>"],area:["100%","100%"],offset:["0","0"],id:e,scrollbar:!1,content:"<div id='serviceframe'>"+a+"</div>",shade:0,anim:2,success:function(t,a){s.isEmptyObject(EY_Service.roomPage[e])&&(EY_Service.roomPage[e]={});var o=EY_Service.userBase[e].uid;c.setChatChange(o),EY_Service.roomPage[e].isScroll=!0,EY_Service.roomPage[e].objRoomCenter=s("#"+c.getRid(o)).find(".room-center"),EY_Service.roomPage[e].objChatArea=EY_Service.roomPage[e].objRoomCenter.find(".chat-cont"),EY_Service.roomPage[e].objChatAct=EY_Service.roomPage[e].objRoomCenter.find(".act-area"),EY_Service.roomPage[e].objInput=EY_Service.roomPage[e].objRoomCenter.find(".chat-input"),EY_Service.roomPage[e].objSend=EY_Service.roomPage[e].objRoomCenter.find(".chat-send");var r=EY_Service.roomPage[e];r.objChatArea.height(s(window).height()-200),c.bindCheckContent(r),c.bindEyToolsFace(r.objRoomCenter.find("button[ey-active='EyToolsFace']")),c.bindEyToolsUpimage(e),c.bindEyToolsUpfile(e),c.setRenderChat(e,!0),c.bottomScroll(e),c.setSpeakStatus(e),i.closeAll("loading",function(){}),updateChatTipTime(e,c.curtime()),EY_Service.roomPage[e].objInput.focus(),_(o,0)},cancel:function(i,t){c.setWin2Me(0,EY_Service.userBase[e].uid)},end:function(){}})})},R=function(e,i){var t=eyui.data("EyTrack")[EY_Service.uinfo.uid]||{},a=t||{};a[e]?(a[e].push(i),a[e].length>50&&a[e].shift()):a[e]=[i],eyui.data("EyTrack",{key:EY_Service.uinfo.uid,value:a})},k=function(e,i){var t=EY_Service.roomPage[e],a=t.objRoomRight.find(".user-track").eq(1);i.time2=o.timeAgo(1e3*i.time),r(s("#trackitem-tpl").html()).render(i,function(e){a.prepend(e),a.find(".track-item").fadeIn("slow")})},P=function(e,i){i.val&&("name"==i.key&&s(".user-name[uid='"+i.uid+"']").html(i.val),"address"==i.key&&s(".user-address[uid='"+i.uid+"']").html(i.val))};setEyUserField=function(e){var t={};if("object"==typeof e){var a=s(e);t.key=a.attr("name"),t.val=a.val()}else{var o=arguments[1]?parseInt(arguments[1]):"";if(""==o)return;t.key=e,t.val=o}"name"==t.key&&""==s.trim(t.val)||(t.uinfo=EY_Service.uinfo,t.formhash=EY_Service.formhash,t.action="eys_setUserField",s.ajax({type:"POST",url:EY_Service.ajxurl,data:t,dataType:"json",success:function(o){var r=O(t.uinfo.oid);"1"==o.code?(r[o.key]=o.val,x(t.uinfo.oid,r),i.msg(EY_Service.lg.act_success),m(EY_Service.roomIndex),P(EY_Service.roomIndex,o),"name"==t.key&&(EY_Service.userBase[EY_Service.roomIndex].name=o.val)):("object"==typeof e&&(a.focus(),a.select(),a.val(r[o.key])),i.msg(EY_Service.lg.tip_err_input))}}))},o.event("ey-active",{EyToolsQr:function(){},EyToolsHistory:function(){c.setRenderHistory(EY_Service.roomIndex),c.setEyChatStatus(EY_Service.userBase[EY_Service.roomIndex].uid)},EyToolsClear:function(e){s(e).parents(".room-center").find(".chat-list").html("")},EyToolsScroll:function(e){EY_Service.roomPage[EY_Service.roomIndex].isScroll?(EY_Service.roomPage[EY_Service.roomIndex].isScroll=!1,s(e).find(".eyui-icon").removeClass("eyui-icon-ok-circle").addClass("eyui-icon-circle")):(EY_Service.roomPage[EY_Service.roomIndex].isScroll=!0,s(e).find(".eyui-icon").removeClass("eyui-icon-circle").addClass("eyui-icon-ok-circle"),c.bottomScroll(EY_Service.roomIndex))},EyToolsTrack:function(e){var i=EY_Service.roomPage[EY_Service.roomIndex];i.isTrack?(i.objRoomRight.find(".user-track").hide(),i.isTrack=!1,s(e).find(".eyui-icon").removeClass("eyui-icon-ok-circle").addClass("eyui-icon-circle")):(i.objRoomRight.find(".user-track").show(),i.isTrack=!0,s(e).find(".eyui-icon").removeClass("eyui-icon-circle").addClass("eyui-icon-ok-circle"))},EyToolsSend:function(e){c.setContent(EY_Service.roomIndex)},EyToolsMonop:function(e){},EyToolsSetting:function(){I()},EySetSpeaker:function(){var e={};e.uid=EY_Service.uinfo.uid,e.lvl=EY_Service.uinfo.lvl,e.v=EY_Service.uinfo.v,e.hash=EY_Service.formhash,e.content=o.escape(s("#speaker_content").val()),c.sendSocket("sendSpeakerAll",e)},EySetOfflineReply:function(){var e={};e.formhash=EY_Service.formhash,e.uinfo=EY_Service.uinfo,e.action="eys_setOfflineReply",e.content=o.escape(s("#offline_reply_content").val()),s.ajax({type:"POST",url:EY_Service.ajxurl,data:e,dataType:"json",success:function(e){"1"==e.code&&(s("#offline_reply_content").val(o.unescape(e.data)),i.msg(EY_Service.lg.act_success))}})},userEnter:function(e){var t=JSON.parse(decodeURIComponent(e.data("json"))),o=c.getRid(t.uid);EY_Service.roomIndex=o,1==EY_Service.comm.h5?T(c.setInitRoomData(t)):0==s("#serviceTab").find("li[lay-id='"+o+"']").length?(i.load(2),C(c.setInitRoomData(t))):a.tabChange("serviceTab",o)},roomQuit:function(e){n.render({elem:e,data:[{title:'<span><i class="eyui-icon eyui-icon-logout"></i> '+EY_Service.lg.roomquit+"</span>",id:"quit"}],align:"center",click:function(i){switch(i.id){case"quit":setRoomQuit(e.attr("data"))}}})}}),a.on("tab(serviceTab)",function(e){var i=this.getAttribute("lay-id"),t=EY_Service.userBase[i].uid;c.setChatChange(t),EY_Service.roomIndex=i,c.bottomScroll(i),s("#serviceTab").find(".eyui-tab-title:first").find("li[lay-id='"+i+"']").find(".eyui-badge-dot").remove(),e.elem.find(".chat-input").focus(),updateChatTipTime(i,c.curtime()),s(".contactlist").find(".user-item").removeClass("user-item-bgcolor"),s(".contactlist").find(".user-item[data='"+t+"']").addClass("user-item-bgcolor")}),a.on("tabDelete(serviceTab)",function(e){EY_Service.uinfo.oid&&(pdata={},pdata.oid=EY_Service.uinfo.oid,pdata.uid=EY_Service.uinfo.uid,pdata.act=0,c.sendSocket("sendChatChange",pdata),delete EY_Service.uinfo.oid,EY_Service.roomIndex=null),s("#serviceTab").find("li").length<=0&&S()});var x=function(e,i){var t=eyui.data("EyRecent")[EY_Service.uinfo.uid]||{},a=t||{};a[e]=i,eyui.data("EyRecent",{key:EY_Service.uinfo.uid,value:a})},O=function(e){var i=eyui.data("EyRecent")[EY_Service.uinfo.uid]||{},t=e?i[e]:i||{};return s.isEmptyObject(t)?{}:t},I=function(){i.open({type:1,title:EY_Service.lg.set,area:["540px","380px"],id:"ey_setting",content:s("#servicesetting-tpl").html(),shade:0,success:function(e,i){U(EY_Service.uinfo.uid)}})},U=function(e){var i={};i.formhash=EY_Service.formhash,i.uinfo=EY_Service.uinfo,i.action="eys_getOfflineReply",s.ajax({type:"POST",url:EY_Service.ajxurl,data:i,dataType:"json",success:function(e){"1"==e.code&&s("#offline_reply_content").val(o.unescape(e.data.content))}})};"WebSocket"in window?c.setWebSocket(EY_Service.cfg.socket,EY_Service.comm.v,EY_Service.uinfo):alert(EY_Service.lg.verlow),e("servicecenter",{})});